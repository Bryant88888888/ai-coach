{% extends "base.html" %}

{% block title %}人事資料 - 寶格教育訓練{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- 標題 -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">人事資料</h1>
            <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">已註冊員工共 {{ users|length }} 人</p>
        </div>
    </div>

    <!-- 訊息提示 -->
    {% if request.query_params.get('success') %}
    <div class="mb-4 p-4 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-xl text-green-700 dark:text-green-400">
        <i class="fas fa-check-circle mr-2"></i>{{ request.query_params.get('success') }}
    </div>
    {% endif %}
    {% if request.query_params.get('error') %}
    <div class="mb-4 p-4 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-xl text-red-700 dark:text-red-400">
        <i class="fas fa-exclamation-circle mr-2"></i>{{ request.query_params.get('error') }}
    </div>
    {% endif %}

    {% if users %}
    <!-- 員工列表 -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">#</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">LINE 名稱</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">LINE ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">真實姓名</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">暱稱</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">手機號碼</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">職位</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">狀態</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">註冊時間</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">操作</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for user in users %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">{{ loop.index }}</td>
                        <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300">{{ user.line_display_name or '-' }}</td>
                        <td class="px-6 py-4">
                            <code class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2 py-1 rounded">{{ user.line_user_id }}</code>
                        </td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-800 dark:text-white">{{ user.real_name }}</td>
                        <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300">{{ user.nickname or '-' }}</td>
                        <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300">{{ user.phone or '-' }}</td>
                        <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300">
                            {% if user.position %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                {% if user.position == '組長' %}bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-400
                                {% elif user.position == '老闆' %}bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-400
                                {% elif user.position == '工程師' %}bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-400
                                {% elif user.position == '助理' %}bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-400
                                {% else %}bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300{% endif %}">
                                {{ user.position }}
                            </span>
                            {% else %}-{% endif %}
                        </td>
                        <td class="px-6 py-4 text-center">
                            {% if user.status == 'Active' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-400">
                                <i class="fas fa-circle text-[6px] mr-1.5"></i>啟用
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-400">
                                <i class="fas fa-circle text-[6px] mr-1.5"></i>停用
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
                            {% if user.registered_at %}
                                {{ user.registered_at.strftime('%Y-%m-%d %H:%M') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-center">
                            <button onclick="openEditModal({{ user.id }}, '{{ user.line_display_name or '' }}', '{{ user.real_name or '' }}', '{{ user.nickname or '' }}', '{{ user.phone or '' }}', '{{ user.position or '' }}', '{{ user.status or 'Active' }}')"
                                class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 transition">
                                <i class="fas fa-pen"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <!-- 無資料 -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-12 text-center">
        <i class="fas fa-user-slash text-4xl text-gray-300 dark:text-gray-600 mb-4"></i>
        <p class="text-gray-500 dark:text-gray-400">目前沒有員工填寫過人事資料</p>
    </div>
    {% endif %}
</div>

<!-- 編輯 Modal -->
<div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md">
        <div class="flex items-center justify-between p-6 border-b dark:border-gray-700">
            <h3 class="text-lg font-bold text-gray-800 dark:text-white">編輯員工資料</h3>
            <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="edit-form" method="POST" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">LINE 名稱</label>
                <input type="text" name="line_display_name" id="edit-line-name"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">真實姓名 <span class="text-red-500">*</span></label>
                <input type="text" name="real_name" id="edit-real-name" required
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">暱稱 <span class="text-red-500">*</span></label>
                <input type="text" name="nickname" id="edit-nickname" required
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">手機號碼 <span class="text-red-500">*</span></label>
                <input type="tel" name="phone" id="edit-phone" required
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">職位</label>
                <select name="position" id="edit-position"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <option value="">-- 未設定 --</option>
                    <option value="組長">組長</option>
                    <option value="老闆">老闆</option>
                    <option value="工程師">工程師</option>
                    <option value="助理">助理</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">狀態</label>
                <select name="active_status" id="edit-active-status"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <option value="Active">啟用</option>
                    <option value="Inactive">停用（離職）</option>
                </select>
            </div>
            <div class="flex gap-3 pt-2">
                <button type="button" onclick="closeEditModal()"
                    class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    取消
                </button>
                <button type="submit"
                    class="flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition">
                    <i class="fas fa-save mr-2"></i>儲存
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function openEditModal(userId, lineName, realName, nickname, phone, position, status) {
        document.getElementById('edit-form').action = `/dashboard/profiles/${userId}/edit`;
        document.getElementById('edit-line-name').value = lineName;
        document.getElementById('edit-real-name').value = realName;
        document.getElementById('edit-nickname').value = nickname;
        document.getElementById('edit-phone').value = phone;
        document.getElementById('edit-position').value = position || '';
        document.getElementById('edit-active-status').value = status || 'Active';
        document.getElementById('edit-modal').classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('edit-modal').classList.add('hidden');
    }

    // 點擊背景關閉
    document.getElementById('edit-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('edit-modal')) {
            closeEditModal();
        }
    });
</script>
{% endblock %}
