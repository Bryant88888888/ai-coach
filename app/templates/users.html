{% extends "base.html" %}

{% block title %}用戶列表 - 寶格教育訓練{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl lg:text-3xl font-bold text-gray-800 dark:text-white">用戶列表</h1>
    <p class="text-gray-600 dark:text-gray-400 mt-1">管理所有新人訓練進度</p>
</div>

<!-- 搜尋與篩選 -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 mb-6">
    <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
            <input type="text" id="search-input" placeholder="搜尋用戶名稱..."
                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 min-h-[44px]">
        </div>
        <div class="flex gap-2">
            <select id="filter-persona" class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 min-h-[44px]">
                <option value="">所有 Persona</option>
                <option value="A_無經驗">A - 無經驗</option>
                <option value="B_有經驗">B - 有經驗</option>
            </select>
            <select id="filter-status" class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 min-h-[44px]">
                <option value="">所有狀態</option>
                <option value="Active">活躍</option>
                <option value="Inactive">停用</option>
            </select>
        </div>
    </div>
</div>

<!-- 用戶列表 -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 dark:text-gray-300">用戶</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 dark:text-gray-300">Persona</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 dark:text-gray-300">進度</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 dark:text-gray-300 hidden md:table-cell">訓練狀態</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 dark:text-gray-300 hidden lg:table-cell">建立時間</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 dark:text-gray-300">操作</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 dark:divide-gray-700" id="users-table-body">
                {% for user in users %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 user-row"
                    data-persona="{{ user.persona if user.persona else '' }}"
                    data-status="{{ user.status }}"
                    data-name="{{ user.line_display_name or user.real_name or '' }}"
                    data-line-id="{{ user.line_user_id }}">
                    <td class="px-4 py-4">
                        <div class="flex items-center">
                            {% if user.line_picture_url %}
                            <img src="{{ user.line_picture_url }}" alt="" class="w-10 h-10 rounded-full mr-3 object-cover">
                            {% else %}
                            <div class="w-10 h-10 rounded-full mr-3 bg-gray-200 dark:bg-gray-600 flex items-center justify-center">
                                <i class="fas fa-user text-gray-400 dark:text-gray-500"></i>
                            </div>
                            {% endif %}
                            <div>
                                <p class="font-medium text-gray-800 dark:text-white">{{ user.line_display_name or '未命名' }}</p>
                                {% if user.real_name %}
                                <p class="text-xs text-gray-500 dark:text-gray-400">本名：{{ user.real_name }}</p>
                                {% else %}
                                <p class="text-xs text-gray-500 dark:text-gray-400 font-mono">{{ user.line_user_id[:16] }}...</p>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4">
                        {% if user.persona %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                            {% if 'A' in user.persona %}bg-pink-100 dark:bg-pink-900/50 text-pink-800 dark:text-pink-300{% else %}bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300{% endif %}">
                            {{ user.persona }}
                        </span>
                        {% else %}
                        <span class="text-gray-400 dark:text-gray-500 text-sm">未分類</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4">
                        {% set training = user.active_training or (user.trainings[0] if user.trainings|length > 0 else None) %}
                        {% set current_day = training.current_day if training else user.current_day %}
                        <div class="flex items-center">
                            <div class="w-24 bg-gray-200 dark:bg-gray-600 rounded-full h-2 mr-2">
                                {% set progress = (current_day / 14 * 100) %}
                                <div class="h-2 rounded-full {% if progress >= 100 %}bg-green-500{% else %}bg-indigo-500{% endif %}"
                                     style="width: {{ [progress, 100]|min }}%"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-800 dark:text-white">Day {{ current_day }}</span>
                        </div>
                    </td>
                    <td class="px-4 py-4 hidden md:table-cell">
                        {% set active_training = user.active_training %}
                        {% if active_training %}
                        <a href="/dashboard/training/batch/{{ active_training.batch_id }}"
                           class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-900">
                            <i class="fas fa-play text-xs mr-1"></i>進行中 Day {{ active_training.current_day }}
                        </a>
                        {% elif user.trainings|length > 0 %}
                            {% set last_training = user.trainings[0] %}
                            {% if last_training.status == 'completed' %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300">
                                <i class="fas fa-check text-xs mr-1"></i>已完成
                            </span>
                            {% elif last_training.status == 'paused' %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 dark:bg-orange-900/50 text-orange-800 dark:text-orange-300">
                                <i class="fas fa-pause text-xs mr-1"></i>已暫停
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-300">
                                <i class="fas fa-clock text-xs mr-1"></i>待開始
                            </span>
                            {% endif %}
                        {% else %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400">
                            <i class="fas fa-minus text-xs mr-1"></i>未安排
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4 text-sm text-gray-600 dark:text-gray-400 hidden lg:table-cell">
                        {{ user.created_at.strftime('%Y-%m-%d %H:%M') }}
                    </td>
                    <td class="px-4 py-4">
                        <a href="/dashboard/users/{{ user.line_user_id }}"
                           class="inline-flex items-center px-3 py-2 bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 rounded-lg hover:bg-indigo-200 dark:hover:bg-indigo-900 transition text-sm min-h-[44px]">
                            <i class="fas fa-eye mr-1"></i>查看
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if not users %}
    <div class="text-center py-12 text-gray-500 dark:text-gray-400">
        <i class="fas fa-users text-5xl mb-4"></i>
        <p class="text-lg">尚無用戶資料</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // 搜尋功能
    const searchInput = document.getElementById('search-input');
    const filterPersona = document.getElementById('filter-persona');
    const filterStatus = document.getElementById('filter-status');
    const rows = document.querySelectorAll('.user-row');

    function filterTable() {
        const search = searchInput.value.toLowerCase();
        const persona = filterPersona.value;
        const status = filterStatus.value;

        rows.forEach(row => {
            const lineId = row.dataset.lineId.toLowerCase();
            const userName = row.dataset.name.toLowerCase();
            const rowPersona = row.dataset.persona;
            const rowStatus = row.dataset.status;

            const matchSearch = userName.includes(search) || lineId.includes(search);
            const matchPersona = !persona || rowPersona === persona;
            const matchStatus = !status || rowStatus === status;

            row.style.display = (matchSearch && matchPersona && matchStatus) ? '' : 'none';
        });
    }

    searchInput.addEventListener('input', filterTable);
    filterPersona.addEventListener('change', filterTable);
    filterStatus.addEventListener('change', filterTable);
</script>
{% endblock %}
