{% extends "base.html" %}

{% block title %}用戶列表 - AI 新人訓練系統{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">用戶列表</h1>
    <p class="text-gray-600 mt-1">管理所有新人訓練進度</p>
</div>

<!-- 搜尋與篩選 -->
<div class="bg-white rounded-xl shadow p-4 mb-6">
    <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
            <input type="text" id="search-input" placeholder="搜尋 LINE User ID..."
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div class="flex gap-2">
            <select id="filter-persona" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                <option value="">所有 Persona</option>
                <option value="A_無經驗">A - 無經驗</option>
                <option value="B_有經驗">B - 有經驗</option>
            </select>
            <select id="filter-status" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                <option value="">所有狀態</option>
                <option value="Active">活躍</option>
                <option value="Inactive">停用</option>
            </select>
        </div>
    </div>
</div>

<!-- 用戶列表 -->
<div class="bg-white rounded-xl shadow overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">用戶</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">Persona</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">進度</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 hidden md:table-cell">狀態</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-600 hidden lg:table-cell">建立時間</th>
                    <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">操作</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100" id="users-table-body">
                {% for user in users %}
                <tr class="hover:bg-gray-50 user-row"
                    data-persona="{{ user.persona.value if user.persona else '' }}"
                    data-status="{{ user.status.value }}"
                    data-line-id="{{ user.line_user_id }}">
                    <td class="px-4 py-4">
                        <div>
                            <p class="font-medium text-gray-800">{{ user.name or '未命名' }}</p>
                            <p class="text-xs text-gray-500 font-mono">{{ user.line_user_id[:16] }}...</p>
                        </div>
                    </td>
                    <td class="px-4 py-4">
                        {% if user.persona %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                            {% if 'A' in user.persona.value %}bg-pink-100 text-pink-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                            {{ user.persona.value }}
                        </span>
                        {% else %}
                        <span class="text-gray-400 text-sm">未分類</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4">
                        <div class="flex items-center">
                            <div class="w-24 bg-gray-200 rounded-full h-2 mr-2">
                                {% set progress = (user.current_day / 14 * 100) %}
                                <div class="h-2 rounded-full {% if progress >= 100 %}bg-green-500{% else %}bg-indigo-500{% endif %}"
                                     style="width: {{ progress }}%"></div>
                            </div>
                            <span class="text-sm font-medium">Day {{ user.current_day }}</span>
                        </div>
                    </td>
                    <td class="px-4 py-4 hidden md:table-cell">
                        {% if user.status.value == 'Active' %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-circle text-xs mr-1"></i>活躍
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            <i class="fas fa-circle text-xs mr-1"></i>停用
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4 text-sm text-gray-600 hidden lg:table-cell">
                        {{ user.created_at.strftime('%Y-%m-%d %H:%M') }}
                    </td>
                    <td class="px-4 py-4">
                        <a href="/dashboard/users/{{ user.line_user_id }}"
                           class="inline-flex items-center px-3 py-1 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition text-sm">
                            <i class="fas fa-eye mr-1"></i>查看
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if not users %}
    <div class="text-center py-12 text-gray-500">
        <i class="fas fa-users text-5xl mb-4"></i>
        <p class="text-lg">尚無用戶資料</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // 搜尋功能
    const searchInput = document.getElementById('search-input');
    const filterPersona = document.getElementById('filter-persona');
    const filterStatus = document.getElementById('filter-status');
    const rows = document.querySelectorAll('.user-row');

    function filterTable() {
        const search = searchInput.value.toLowerCase();
        const persona = filterPersona.value;
        const status = filterStatus.value;

        rows.forEach(row => {
            const lineId = row.dataset.lineId.toLowerCase();
            const rowPersona = row.dataset.persona;
            const rowStatus = row.dataset.status;

            const matchSearch = lineId.includes(search);
            const matchPersona = !persona || rowPersona === persona;
            const matchStatus = !status || rowStatus === status;

            row.style.display = (matchSearch && matchPersona && matchStatus) ? '' : 'none';
        });
    }

    searchInput.addEventListener('input', filterTable);
    filterPersona.addEventListener('change', filterTable);
    filterStatus.addEventListener('change', filterTable);
</script>
{% endblock %}
