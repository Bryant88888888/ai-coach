{% extends "base.html" %}

{% block title %}請假管理 - 寶格教育訓練{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl lg:text-3xl font-bold text-gray-800 dark:text-white">請假管理</h1>
    <p class="text-gray-600 dark:text-gray-400 mt-1">審核員工請假申請</p>
</div>

<!-- 篩選選項 -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 mb-6">
    <div class="flex flex-col sm:flex-row gap-3">
        <select id="filter-status" class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 min-h-[44px]">
            <option value="">所有狀態</option>
            <option value="pending" selected>待審核</option>
            <option value="approved">已核准</option>
            <option value="rejected">已拒絕</option>
        </select>
        <select id="filter-type" class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 min-h-[44px]">
            <option value="">所有類型</option>
            <option value="事假">事假</option>
            <option value="病假">病假</option>
        </select>
    </div>
</div>

<!-- 統計卡片 -->
<div class="grid grid-cols-3 gap-3 mb-6">
    <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-xl p-4 text-center">
        <p class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">{{ pending_count }}</p>
        <p class="text-sm text-yellow-700 dark:text-yellow-300">待審核</p>
    </div>
    <div class="bg-green-50 dark:bg-green-900/30 rounded-xl p-4 text-center">
        <p class="text-2xl font-bold text-green-600 dark:text-green-400">{{ approved_count }}</p>
        <p class="text-sm text-green-700 dark:text-green-300">已核准</p>
    </div>
    <div class="bg-red-50 dark:bg-red-900/30 rounded-xl p-4 text-center">
        <p class="text-2xl font-bold text-red-600 dark:text-red-400">{{ rejected_count }}</p>
        <p class="text-sm text-red-700 dark:text-red-300">已拒絕</p>
    </div>
</div>

<!-- 請假列表 -->
<div class="space-y-4" id="leave-list">
    {% for req in leave_requests %}
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow overflow-hidden leave-item"
         data-status="{{ req.status }}"
         data-type="{{ req.leave_type }}">
        <!-- 標頭 -->
        <div class="p-4 border-b dark:border-gray-700">
            <div class="flex flex-wrap items-center justify-between gap-2">
                <div class="flex items-center gap-3">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                        {% if req.leave_type == '事假' %}bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300
                        {% else %}bg-purple-100 dark:bg-purple-900/50 text-purple-800 dark:text-purple-300{% endif %}">
                        <i class="{% if req.leave_type == '事假' %}fas fa-briefcase{% else %}fas fa-notes-medical{% endif %} mr-1"></i>
                        {{ req.leave_type }}
                    </span>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                        {% if req.status == 'pending' %}bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-300
                        {% elif req.status == 'approved' %}bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300
                        {% else %}bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-300{% endif %}">
                        {% if req.status == 'pending' %}<i class="fas fa-clock mr-1"></i>待審核
                        {% elif req.status == 'approved' %}<i class="fas fa-check mr-1"></i>已核准
                        {% else %}<i class="fas fa-times mr-1"></i>已拒絕{% endif %}
                    </span>
                </div>
                <span class="text-sm text-gray-500 dark:text-gray-400">
                    <i class="fas fa-calendar mr-1"></i>{{ req.created_at.strftime('%m/%d %H:%M') }}
                </span>
            </div>
        </div>

        <!-- 內容 -->
        <div class="p-4">
            <div class="flex items-start gap-4">
                <!-- LINE 頭像 -->
                <div class="w-14 h-14 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden flex-shrink-0">
                    {% if req.line_picture_url %}
                    <img src="{{ req.line_picture_url }}" alt="" class="w-full h-full object-cover">
                    {% else %}
                    <div class="w-full h-full flex items-center justify-center">
                        <i class="fas fa-user text-2xl text-gray-400"></i>
                    </div>
                    {% endif %}
                </div>
                <div class="flex-1">
                    <div class="mb-2">
                        <span class="font-bold text-lg text-gray-800 dark:text-white">{{ req.applicant_name or req.user.name or '未命名' }}</span>
                        {% if req.line_display_name %}
                        <span class="text-sm text-gray-500 dark:text-gray-400 ml-2">({{ req.line_display_name }})</span>
                        {% endif %}
                    </div>
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fas fa-calendar-day text-gray-400"></i>
                        <span class="text-gray-700 dark:text-gray-300">請假日期：<strong>{{ req.leave_date }}</strong></span>
                    </div>

                    {% if req.reason %}
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 mb-3">
                        <p class="text-sm text-gray-600 dark:text-gray-300">
                            <i class="fas fa-quote-left text-gray-400 mr-1"></i>
                            {{ req.reason }}
                        </p>
                    </div>
                    {% endif %}

                    {% if req.proof_file %}
                    <div class="mb-3">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">
                            <i class="fas fa-file-medical mr-1"></i>病假證明：
                        </p>
                        <div class="relative group">
                            <img src="/static/uploads/{{ req.proof_file }}"
                                 alt="病假證明"
                                 class="max-w-full max-h-48 rounded-lg border border-gray-200 dark:border-gray-600 cursor-pointer hover:opacity-90 transition"
                                 onclick="showImageModal('/static/uploads/{{ req.proof_file }}')">
                            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition pointer-events-none">
                                <span class="bg-black/50 text-white px-3 py-1 rounded-full text-sm">
                                    <i class="fas fa-search-plus mr-1"></i>點擊放大
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if req.reviewer_note %}
                    <div class="bg-gray-100 dark:bg-gray-600 rounded-lg p-3 text-sm">
                        <span class="text-gray-500 dark:text-gray-400">審核備註：</span>
                        <span class="text-gray-700 dark:text-gray-300">{{ req.reviewer_note }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- 審核按鈕 (只有待審核顯示) -->
            {% if req.status == 'pending' %}
            <div class="mt-4 pt-4 border-t dark:border-gray-700">
                <form method="POST" action="/dashboard/leave/{{ req.id }}/review" class="space-y-3">
                    <div>
                        <input type="text" name="reviewer_note" placeholder="審核備註（選填）"
                               class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 min-h-[44px]">
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" name="action" value="approve"
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition min-h-[48px] flex items-center justify-center">
                            <i class="fas fa-check mr-2"></i>核准
                        </button>
                        <button type="submit" name="action" value="reject"
                                class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-4 rounded-lg transition min-h-[48px] flex items-center justify-center">
                            <i class="fas fa-times mr-2"></i>拒絕
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    {% if not leave_requests %}
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-12 text-center">
        <i class="fas fa-inbox text-5xl text-gray-300 dark:text-gray-600 mb-4"></i>
        <p class="text-gray-500 dark:text-gray-400 text-lg">目前沒有請假申請</p>
    </div>
    {% endif %}
</div>

<!-- 圖片放大 Modal -->
<div id="image-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4" onclick="hideImageModal()">
    <div class="relative max-w-4xl max-h-full" onclick="event.stopPropagation()">
        <img id="modal-image" src="" alt="證明文件" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl">
        <button onclick="hideImageModal()" class="absolute top-2 right-2 w-10 h-10 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-lg transition">
            <i class="fas fa-times text-gray-800 text-xl"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 圖片 Modal 功能
    function showImageModal(src) {
        const modal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        modalImage.src = src;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
    }

    function hideImageModal() {
        const modal = document.getElementById('image-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = '';
    }

    // ESC 鍵關閉 modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideImageModal();
        }
    });

    const filterStatus = document.getElementById('filter-status');
    const filterType = document.getElementById('filter-type');
    const leaveItems = document.querySelectorAll('.leave-item');

    function filterList() {
        const status = filterStatus.value;
        const type = filterType.value;

        leaveItems.forEach(item => {
            const itemStatus = item.dataset.status;
            const itemType = item.dataset.type;

            const matchStatus = !status || itemStatus === status;
            const matchType = !type || itemType === type;

            item.style.display = (matchStatus && matchType) ? '' : 'none';
        });
    }

    filterStatus.addEventListener('change', filterList);
    filterType.addEventListener('change', filterList);

    // 初始化篩選
    filterList();
</script>
{% endblock %}
