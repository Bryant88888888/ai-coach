{% extends "base.html" %}

{% block title %}排班設定 - 寶格教育訓練{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 mb-2">
        <a href="/dashboard/duty" class="hover:text-indigo-600 dark:hover:text-indigo-400">值日生管理</a>
        <i class="fas fa-chevron-right text-xs"></i>
        <span>排班設定</span>
    </div>
    <h1 class="text-2xl lg:text-3xl font-bold text-gray-800 dark:text-white">排班設定</h1>
    <p class="text-gray-600 dark:text-gray-400 mt-1">設定值日生排班規則與任務</p>
</div>

{% if success_message %}
<div class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 text-green-700 dark:text-green-400 px-4 py-3 rounded-xl mb-6 flex items-center">
    <i class="fas fa-check-circle mr-3 text-xl"></i>
    <span>{{ success_message }}</span>
</div>
{% endif %}

{% if error_message %}
<div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 px-4 py-3 rounded-xl mb-6 flex items-center">
    <i class="fas fa-exclamation-circle mr-3 text-xl"></i>
    <span>{{ error_message }}</span>
</div>
{% endif %}

<!-- 新增設定 -->
{% if not config %}
<div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
        <i class="fas fa-plus-circle text-indigo-500 mr-2"></i>建立排班設定
    </h2>
    <form method="POST" action="/dashboard/duty/config" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    設定名稱 <span class="text-red-500">*</span>
                </label>
                <input type="text" name="name" required value="清潔值日"
                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 min-h-[44px]">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    每日值日人數
                </label>
                <input type="number" name="members_per_day" value="1" min="1" max="10"
                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 min-h-[44px]">
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                提醒時間
            </label>
            <input type="time" name="notify_time" value="08:00"
                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 min-h-[44px]">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                任務清單（每行一項）
            </label>
            <textarea name="tasks" rows="5" placeholder="掃地拖地&#10;倒垃圾&#10;整理桌面&#10;擦拭玻璃"
                      class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500"></textarea>
        </div>
        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-6 rounded-lg transition min-h-[44px]">
            <i class="fas fa-save mr-2"></i>建立設定
        </button>
    </form>
</div>
{% else %}
<!-- 編輯設定 -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-white">
            <i class="fas fa-cog text-indigo-500 mr-2"></i>{{ config.name }}
        </h2>
        <span class="px-3 py-1 rounded-full text-sm font-medium
            {% if config.is_active %}bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-400
            {% else %}bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-400{% endif %}">
            {% if config.is_active %}啟用中{% else %}已停用{% endif %}
        </span>
    </div>
    <form method="POST" action="/dashboard/duty/config/{{ config.id }}" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    設定名稱 <span class="text-red-500">*</span>
                </label>
                <input type="text" name="name" required value="{{ config.name }}"
                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 min-h-[44px]">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    每日值日人數
                </label>
                <input type="number" name="members_per_day" value="{{ config.members_per_day }}" min="1" max="10"
                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 min-h-[44px]">
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                提醒時間
            </label>
            <input type="time" name="notify_time" value="{{ config.notify_time }}"
                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500 min-h-[44px]">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                任務清單（每行一項）
            </label>
            <textarea name="tasks" rows="5"
                      class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-indigo-500">{% for task in config.get_tasks() %}{{ task }}{% if not loop.last %}
{% endif %}{% endfor %}</textarea>
        </div>
        <div class="flex items-center gap-4">
            <label class="flex items-center cursor-pointer">
                <input type="checkbox" name="is_active" {% if config.is_active %}checked{% endif %}
                       class="w-4 h-4 text-indigo-600 rounded">
                <span class="ml-2 text-gray-700 dark:text-gray-300">啟用此設定</span>
            </label>
        </div>
        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-6 rounded-lg transition min-h-[44px]">
            <i class="fas fa-save mr-2"></i>儲存設定
        </button>
    </form>
</div>
{% endif %}

{% set weekday_names = ['星期一', '星期二', '星期三', '星期四', '星期五', '星期六', '星期日'] %}

<!-- 值日生排班規則 -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 mb-6 border-l-4 border-blue-500">
    <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-1">
        <i class="fas fa-calendar-check text-blue-500 mr-2"></i>值日生排班規則
    </h2>
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">每個星期幾指定值日生（可多人），生成排班時將按此規則指派</p>
    <form method="POST" action="/dashboard/duty/rules/save" class="space-y-3" id="duty_form">
        <input type="hidden" name="rule_type" value="duty">
        {% for i in range(7) %}
        <div class="flex items-start gap-3">
            <span class="w-16 text-sm font-medium text-gray-700 dark:text-gray-300 shrink-0 pt-2">{{ weekday_names[i] }}</span>
            <div class="flex-1">
                <input type="hidden" name="weekday_{{ i }}" id="duty_uid_{{ i }}"
                       value="{% if duty_rules.get(i) %}{{ duty_rules[i]|map(attribute='id')|join(',') }}{% endif %}">
                <!-- 已選人員標籤 -->
                <div id="duty_tags_{{ i }}" class="flex flex-wrap gap-1 mb-1">
                    {% if duty_rules.get(i) %}
                    {% for u in duty_rules[i] %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300" data-uid="{{ u.id }}">
                        {{ u.nickname or u.real_name }}
                        <button type="button" onclick="removeTag('duty', {{ i }}, {{ u.id }})" class="hover:text-red-500 ml-0.5">&times;</button>
                    </span>
                    {% endfor %}
                    {% endif %}
                </div>
                <!-- 選人輸入框 -->
                <div class="relative" data-picker="duty_{{ i }}">
                    <input type="text" id="duty_search_{{ i }}" placeholder="搜尋並新增人員..."
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm min-h-[40px] focus:ring-2 focus:ring-blue-500"
                           onfocus="openPicker('duty', {{ i }})" oninput="filterOptions('duty', {{ i }})">
                    <div id="duty_dropdown_{{ i }}" class="hidden absolute z-20 mt-1 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                        {% for user in duty_eligible %}
                        <div class="px-3 py-2 hover:bg-blue-50 dark:hover:bg-blue-900/30 cursor-pointer text-sm text-gray-800 dark:text-gray-200 transition"
                            data-uid="{{ user.id }}"
                            data-name="{{ user.nickname or user.real_name }}"
                            data-search="{{ (user.nickname or '')|lower }}{{ user.real_name|lower }}"
                            onclick="addTag('duty', {{ i }}, this)">
                            {{ user.nickname or user.real_name }}（{{ user.real_name }}）
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        <div class="pt-2">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition min-h-[44px]">
                <i class="fas fa-save mr-2"></i>儲存值日生規則
            </button>
        </div>
    </form>
</div>

<!-- 組長排班規則 -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 mb-6 border-l-4 border-purple-500">
    <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-1">
        <i class="fas fa-user-tie text-purple-500 mr-2"></i>組長排班規則
    </h2>
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">每個星期幾指定駐店組長（可多人），僅顯示職位為「組長」的員工</p>
    <form method="POST" action="/dashboard/duty/rules/save" class="space-y-3" id="leader_form">
        <input type="hidden" name="rule_type" value="leader">
        {% for i in range(7) %}
        <div class="flex items-start gap-3">
            <span class="w-16 text-sm font-medium text-gray-700 dark:text-gray-300 shrink-0 pt-2">{{ weekday_names[i] }}</span>
            <div class="flex-1">
                <input type="hidden" name="weekday_{{ i }}" id="leader_uid_{{ i }}"
                       value="{% if leader_rules.get(i) %}{{ leader_rules[i]|map(attribute='id')|join(',') }}{% endif %}">
                <!-- 已選人員標籤 -->
                <div id="leader_tags_{{ i }}" class="flex flex-wrap gap-1 mb-1">
                    {% if leader_rules.get(i) %}
                    {% for u in leader_rules[i] %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300" data-uid="{{ u.id }}">
                        {{ u.nickname or u.real_name }}
                        <button type="button" onclick="removeTag('leader', {{ i }}, {{ u.id }})" class="hover:text-red-500 ml-0.5">&times;</button>
                    </span>
                    {% endfor %}
                    {% endif %}
                </div>
                <!-- 選人輸入框 -->
                <div class="relative" data-picker="leader_{{ i }}">
                    <input type="text" id="leader_search_{{ i }}" placeholder="搜尋並新增人員..."
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm min-h-[40px] focus:ring-2 focus:ring-purple-500"
                           onfocus="openPicker('leader', {{ i }})" oninput="filterOptions('leader', {{ i }})">
                    <div id="leader_dropdown_{{ i }}" class="hidden absolute z-20 mt-1 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                        {% for user in leader_eligible %}
                        <div class="px-3 py-2 hover:bg-purple-50 dark:hover:bg-purple-900/30 cursor-pointer text-sm text-gray-800 dark:text-gray-200 transition"
                            data-uid="{{ user.id }}"
                            data-name="{{ user.nickname or user.real_name }}"
                            data-search="{{ (user.nickname or '')|lower }}{{ user.real_name|lower }}"
                            onclick="addTag('leader', {{ i }}, this)">
                            {{ user.nickname or user.real_name }}（{{ user.real_name }}）
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        <div class="pt-2">
            <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-lg transition min-h-[44px]">
                <i class="fas fa-save mr-2"></i>儲存組長規則
            </button>
        </div>
    </form>
</div>

<!-- 說明 -->
<div class="bg-blue-50 dark:bg-blue-900/30 rounded-xl p-4">
    <h3 class="font-semibold text-blue-800 dark:text-blue-300 mb-2">
        <i class="fas fa-lightbulb mr-2"></i>排班設定說明
    </h3>
    <ul class="text-sm text-blue-700 dark:text-blue-400 space-y-1 list-disc list-inside">
        <li>排班規則：每個星期幾可指定多位人員，自動排班時按規則指派（未設定的日期不排班）</li>
        <li>提醒時間：系統在此時間透過 LINE 提醒當日值日生</li>
        <li>任務清單：值日生回報時需要勾選的任務項目</li>
    </ul>
</div>

<script>
let activeDropdown = null;

function getSelectedIds(type, idx) {
    var val = document.getElementById(type + '_uid_' + idx).value;
    if (!val) return [];
    return val.split(',').filter(function(s) { return s; });
}

function setSelectedIds(type, idx, ids) {
    document.getElementById(type + '_uid_' + idx).value = ids.join(',');
}

function openPicker(type, idx) {
    var dropdownId = type + '_dropdown_' + idx;
    var dropdown = document.getElementById(dropdownId);

    if (activeDropdown && activeDropdown !== dropdownId) {
        document.getElementById(activeDropdown).classList.add('hidden');
    }

    dropdown.classList.remove('hidden');
    activeDropdown = dropdownId;
    filterOptions(type, idx);
}

function filterOptions(type, idx) {
    var searchInput = document.getElementById(type + '_search_' + idx);
    var dropdown = document.getElementById(type + '_dropdown_' + idx);
    var keyword = searchInput.value.toLowerCase();
    var items = dropdown.querySelectorAll('[data-uid]');
    var selectedIds = getSelectedIds(type, idx);

    items.forEach(function(item) {
        var uid = item.getAttribute('data-uid');
        var searchText = item.getAttribute('data-search');
        var isSelected = selectedIds.indexOf(uid) !== -1;
        var matchesSearch = searchText.indexOf(keyword) !== -1;
        item.style.display = (!isSelected && matchesSearch) ? '' : 'none';
    });
}

function addTag(type, idx, el) {
    var uid = el.getAttribute('data-uid');
    var name = el.getAttribute('data-name');
    var ids = getSelectedIds(type, idx);

    if (ids.indexOf(uid) !== -1) return;

    ids.push(uid);
    setSelectedIds(type, idx, ids);

    var colorClass = type === 'duty'
        ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300'
        : 'bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300';

    var tag = document.createElement('span');
    tag.className = 'inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ' + colorClass;
    tag.setAttribute('data-uid', uid);
    tag.innerHTML = name + ' <button type="button" onclick="removeTag(\'' + type + '\', ' + idx + ', ' + uid + ')" class="hover:text-red-500 ml-0.5">&times;</button>';

    document.getElementById(type + '_tags_' + idx).appendChild(tag);

    // 清空搜尋、重新過濾（隱藏已選）
    document.getElementById(type + '_search_' + idx).value = '';
    filterOptions(type, idx);
}

function removeTag(type, idx, uid) {
    var ids = getSelectedIds(type, idx);
    ids = ids.filter(function(id) { return id !== String(uid); });
    setSelectedIds(type, idx, ids);

    var tagsContainer = document.getElementById(type + '_tags_' + idx);
    var tag = tagsContainer.querySelector('[data-uid="' + uid + '"]');
    if (tag) tag.remove();

    // 重新過濾以顯示移除的人
    filterOptions(type, idx);
}

// 點擊外部關閉 dropdown
document.addEventListener('click', function(e) {
    if (activeDropdown) {
        var dropdown = document.getElementById(activeDropdown);
        var parent = dropdown.parentElement;
        if (!parent.contains(e.target)) {
            dropdown.classList.add('hidden');
            activeDropdown = null;
        }
    }
});
</script>
{% endblock %}
